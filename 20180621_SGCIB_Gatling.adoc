= BBL Tests de charge avec Gatling
Thomas SCHWENDER <https://github.com/ardemius[@ardemius]>
// Handling GitHub admonition blocks icons
ifndef::env-github[:icons: font]
ifdef::env-github[]
:status:
:outfilesuffix: .adoc
:caution-caption: :fire:
:important-caption: :exclamation:
:note-caption: :paperclip:
:tip-caption: :bulb:
:warning-caption: :warning:
endif::[]
:imagesdir: images
:source-highlighter: highlightjs
// Next 2 ones are to handle line breaks in some particular elements (list, footnotes, etc.)
:lb: pass:[<br> +]
:sb: pass:[<br>]
// check https://github.com/Ardemius/personal-wiki/wiki/AsciiDoctor-tips for tips on table of content in GitHub
:toc: macro
//:toclevels: 3
// To turn off figure caption labels and numbers
:figure-caption!:
// Same for examples
:example-caption!:

toc::[]

Pr√©sent√© par *St√©phane LANDELLE*, cr√©ateur de Gatling.

== Abstract

.Comment arr√™ter de croiser les doigts lorsqu'on passe en prod ?
====
Face √† l'explosion du trafic sur internet et la croissance exponentielle de l'√©conomie num√©rique, la performance des applications devient un enjeu majeur des projets informatiques. +
Pourtant, il est fr√©quent que le  √©quipes adressent mal les tests de charges. +
La premi√®re partie de cette pr√©sentation pr√©sente les concepts de tests de charge et leur m√©thodologie. +
La seconde se focalise sur Gatling. Gatling est un outil de test de charge open-source, utilis√© pour g√©n√©rer des utilisateurs virtuels naviguant sur un site web.

Il se caract√©rise par :

* une architecture moderne et performante bas√©e sur des IO non-bloquants et un mod√®le d'acteurs, vous permettant de g√©n√©rer un tr√®s grand nombre d'utilisateurs concurrents
* un DSL concis et lisible vous permettant d'√©crire un code flexible et maintenable, plut√¥t qu'une interface graphique consue
* des rapports √©l√©gants et aux m√©triques pertinentes
====

== Notes

St√©phane travaille pour https://gatling.io/[Gatling Corp] (6 personnes actuellement), qui pousse l'utilisation de Gatling open source, et propose √©galement une *version enterprise* (nomm√©e *Frontline*).

NOTE: Gatling Corp va s'installer √† Station F dans l'√©t√©.

*Constat* : nos applications ne sont plus du tout soumises aux m√™mes contraintes que celles du d√©but 2000. +
-> Le web est devenu le 1er m√©dia de vente, avec les potentielles mont√©es en charge que cela implique.

* Les tests de charge sont un process it√©ratif. +
-> on adresse les probl√®mes les uns apr√®s les autres

.Conseil de St√©phane
NOTE: Faire les tests de charge le plus t√¥t possible.

* Les tests de charge sont beaucoup plus faciles √† maintenir que les tests d'interface (√† la Selenium). +
-> Plus facile de changer un payload JSON que de changer un test Selenium.

.Attention aux *Load Injector*
[WARNING]
====
Ils attaquent sans cesse *la m√™me URL statique*. 

httpd est fourni avec https://httpd.apache.org/docs/current/programs/ab.html[un outil de benchmarking, ("ab")], qui est un URL basher. +
-> les URL bashers sont plut√¥t des outils de *test*, et non des outils de test de charge.

Ces URL bashers ne permettent la plupart du temps de ne tester qu'un "chemin", ce qui ne permet finalement que de *tester les caches de son application*.
====

-> Un *bon* outil de test de charge permet de *simuler le trafic*, ainsi que les *diff√©rents comportements utilisateurs* (diff√©rents chemins, et non le seul test d'une URL statique).


Ces "chemins" peuvent concerner : 

* Le (ou les) cache de l'application
* Les optimisations apport√©es par le JIT de Java
* etc.

image::20180621_Gatling_01.jpg[]

* MQTT seulement en version entreprise
* Gatling est tr√®s utilis√© pour les tests de protocoles de messaging (car s'y pr√™te bien)

Gatling est tr√®s performant quand compar√© aux autres outils du march√©, qui, pour la plupart, ont √©t√© cr√©√©s il y a longtemps, √† une √©poque o√π le mat√©riel √©tait diff√©rent (mono-coeur)

* Principales caract√©ristique de l'architecture de Gatling : *messaging* (Akka) et *non blocking IO* (Netty) 
* ~40 threads par coeur pour Gatling
* tous les threads sont quasiment tous √† 100% en permanence (cons√©quence des IO non bloquants)
* Gatling est capable de g√©rer √©norm√©ment de charge. +
-> Quand on atteint une limite de charge, il y a de fortes chances que cela vienne en fait du r√©seau (ex : carte r√©seau 1 Go qu'il faudrait changer pour une 10 Go)

Historiquement les outils de test de charge (le 1er √©tait *Load Runner*) √©taient des outils graphiques, et donc assez difficilement maintenables (n√©cessit√© d'aller chercher dans l'interface graphique)

* Pas d'interface graphique avec Gatling, mais *du code*
+
image::20180621_Gatling_02.jpg[]
+
* Gatling fournit un *DSL* (avec du method chaining)
+
image::20180621_Gatling_03.jpg[]
+
* les *assertions* permettent de tester les *crit√®res d'acceptance*
* le langage de programmation derri√®re Gatling est *Scala*

.Autre point d'attention
WARNING: Ne pas se fier aux *moyennes*, ni aux *standard deviations* (√©cart type, ce dernier n'√©tant valable que pour des distributions *normales*)

-> Pr√©f√©rer l'utilisation de centiles (*percentiles*) +
C'est un classique, pour plus d'informations √† ce sujet, et sur les Hiccups, voir https://github.com/Ardemius/meetups-talks-conferences-notes/blob/master/2015-devoxx-france/understanding-latency.adoc[le CR de la conf Understanding Latency de Gil Tene], lors de Devoxx France 2015.

NOTE: St√©phane indique que JMH n'est pas viable quant √† ses centiles (quant √† la mani√®re dont il les calcule) +
-> *A creuser*, mais semble √©tonnant, c'est l'outil de r√©f√©rence en la mati√®re, je n'avais encore jamais eu ce retour dessus.

* *Moyenner des centiles* fait perdre tout int√©r√™t √† ces derniers

.Int√©gration avec d'autres outils
image::20180621_Gatling_04.jpg[]

NOTE: Support de Kubernetes et OpenShift d'ici la fin d'ann√©e. +
-> Encore une confirmation de la domination de Kubernetes sur le march√©, et de la mont√©e en puissance d'OpenShift.

== Demo de Gatling Enterprise (Frontline)

Demo sur Eclipse, et pas IntelliJ ! üòÉ

* Attention aux probl√®mes *SSL* (HTTPS). +
Bien lire la doc pour la *gestion des certificats* et des man-in-the-middle.

Exemple de code :

image::20180621_Gatling_05.jpg[]

* *Mod√®le ferm√©* : on a le contr√¥le sur le nombre d'utilisateurs concurrents (analogie avec un Call Center : "Tous nos op√©rateurs sont occup√©s, merci de bien vouloir attendre X minutes...") +
-> Traduction pour un outil de test de charge : 10 utilisateurs sur 2 min, puis (acc√©l√©ration) 100 users sur 1 sec. +
C'est le mod√®le le plus adapt√© au web, mais...

* Malheureusement la plupart des applications ne fonctionnent ainsi, mais en *mod√®le ouvert* : tous les utilisateurs essayent d'acc√©der √† l'application en m√™me temps... +
-> Traduction pour un outil de test de charge : 10 utilisateurs sur 2 min, puis (acc√©l√©ration) 100 users sur 1 sec. 

IMPORTANT: Il faut donc expliquer aux personnes demandant les tests que *raisonner en termes de nombres d'utilisateurs concurrents du syst√®me n'a pas de sens*.

* Dans Gatling, le *comportement par d√©faut* est de *stocker les data dans une queue*. +
-> Quand il n'y a plus de data dans la queue et qu'un nouveau test est demand√©, Gatling remonte une erreur (apparemment "comportement ind√©termin√©")

* *Feeder* : it√©rateur qui retourne des maps de <string, object>

.Attention aux builders !
[IMPORTANT]
====
Les builders ne sont *√©valu√©s qu'une fois*, √† l'initiation de la suite de tests. +
Un random dans un builder ne sera √©valu√© qu'une fois, et c'est donc la m√™me donn√©e qui sera ensuite fournie √† tous les tests.

Pour √©viter cela, passer une fonction en param√®tre du builder (donc utiliser une Lambda, afin d'utiliser non pas une valeur mais un comportement)
====

.Architecture de Gatling *Enterprise* (Frontline)
image::20180621_Gatling_06.jpg[]

* *Cassandra* est utilis√© non pas pour des raisons "(Big) Data", mais pour sa *gestion des time-series binaires* +
(En comparaison, InfluxDB ne peut stocker que des time-series num√©riques)

.Pourquoi des time-series binaires ?
[NOTE]
====
Gatling stocke des distributions de m√©triques (~tableaux de comptage, time-series), et *non des centiles*. +
Pour gagner de la place, Gatling compresse ces tableaux (via un algo sp√©cifique propri√©taire).

En effet, St√©phane nous a d√©j√† expliqu√© qu'il n'√©tait pas pertinent d'aggr√©ger des centiles, pour les probl√®mes de moyennes que l'on conna√Æt (disparation de certaines valeurs au profit de la moyenne).
====

* Frontline est uniquement disponible sous forme d'instance priv√©e (donc *pas de SaaS*)
	** Bient√¥t (fin 2018 ?) disponible sur Amazon +
	-> Une preuve de plus d'un passage global des techno √† une *strat√©gie public cloud* 

.Adoption d'OpenShift
NOTE: St√©phane nous indique qu'OpenShift va √™tre support√© par Gatling, car d√©j√† utilis√© par les 2/3 de leurs clients pour leur cluster priv√©.

* Beaucoup plus de dashboards disponibles avec Frontline que dans la version Open Source.
* monitoring de l'activit√© m√©moire, du CPU, et de la *charge des injecteurs* (pour v√©rifier qu'on ne les sature pas)
* API REST document√©e sur *Swagger*

== Conclusion

Le travail effectu√© par Gatling Corp est impressionant. +
Frontline semble √™tre un outil complet, r√©pondant √† un grand nombre de use cases (pour des tests de charge), et ayant n√©cessit√© de la recherche, du d√©veloppement custom de composants (et pas uniquement de la r√©utilisation de composants existants).

St√©phane ma√Ætrise le sujet, ainsi que la "th√©orie" des tests sous-jacente. +
-> On voit bien que g√©rer ses tests de charge n√©cessite des connaissances, et ne s'improvise pas. +
En fonction de ses moyens (temps, ressources), plut√¥t que de monter une √©quipe interne, on peut envisager passer par Gatling Corp.

Autre info de St√©phane : le projet en vogue en ce moment (pour collecter et analyser des m√©triques) : https://prometheus.io/[*Prometheus*] +
-> D√©j√† bien mis en avant lors du dernier Devoxx France, voir le CR de la conf https://github.com/Ardemius/meetups-talks-conferences-notes/blob/6eb85dcf8f01b40cf3fd176518132d3896e69559/2018-devoxx-france/mercredi/mercredi_1755-1825_Prometheus-monitoring.adoc[Prometheus, un outil pour les monitor tous]







